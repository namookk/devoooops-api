# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
# This workflow will build a Java project with Gradle and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-gradle
stage:
  - test
  - build
  - deploy-dev
  - deploy-prod

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

name: Java CI with Gradle
jobs:
  build:

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
      - name: Build with Gradle
        uses: gradle/gradle-build-action@4137be6a8bf7d7133955359dbd952c0ca73b1021
        with:
          arguments: build

테스트:
  stage: test
  only:
    - master
    - develop
    - /^feature.*/
    - /^fix.*/
    - /^hotfix.*/
    - yj
    - jh
  script:
    - echo '### 테스트'
    - pwd
  tags:
    - test

빌드:
  stage: build
  only:
    - master
    - dev
    - /^feat.*/
    - /^hotfix.*/
  artifacts:
    paths:
      - b2b-api/target/dev-Oooops-*.jar
    expire_in: 14 days
  script:
    - echo '### 빌드'
    - mvn clean package
    - pwd
  tags:
    - build

개발-API-배포:
  stage: deploy-prod
  only:
    - master
  script:
    - echo '### api 배포'
    - ssh -i ~/.ssh/devoooops.pem root@3.34.151.172
    - sleep 10
    - ssh -i ~/.ssh/devoooops.pem root@3.34.151.172 rm -f /opt/dev-oooops/dev-Oooops-*.jar
    - scp dev-Oooops/target/dev-Oooops-*.jar -i ~/.ssh/devoooops.pem root@3.34.151.172:/opt/dev-oooops/
    - ssh -i ~/.ssh/devoooops.pem root@3.34.151.172 /opt/dev-oooops/start.sh
    - pwd
  tags:
    - deploy
  when: manual

